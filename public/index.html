<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>AVN Player</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Container for HTML overlays (iframes) -->
  <div id="iframe-container"></div>
  <!-- NEW: Container for Markdown overlays -->
  <div id="markdown-container"></div>

  <canvas id="graphCanvas" title="Graph"></canvas>

  <!-- UNIFIED TOP TOOLBAR -->
  <div id="topToolbar">
    <!-- Mode Switcher (Always Visible) -->
    <button id="toggleEditorModeBtn" title="Toggle Player/Editor Mode">🛠️🖥️🖱️</button>
    <div class="divider"></div>

    <!-- Always Visible Buttons -->
    <button id="toggleAllNodesBtn" title="Collapse All Nodes">➖</button>
    <button id="followModeBtn" title="Lock current view and follow playback">🎯</button> 
    <button id="selectGraphBtn" title="Select Story" disabled>📂</button>
    <div class="divider"></div>

    <!-- Player Mode Controls -->
    <div id="playerModeControls">
      <div id="playbackModeSwitch" class="toggle-switch" title="Set Playback Mode">
        <button id="mode-default" class="active" title="Play only default paths">Default</button>
        <button id="mode-alternative" title="Play only alternative paths">Alts</button>
        <button id="mode-random" title="Play any path randomly">Random</button>
      </div>
    </div>

    <!-- Editor Mode Controls (hidden by default) -->
    <div id="editorModeControls">
      <button id="addNodeBtn" title="Add New Node">🎫</button>
      <button id="addRectBtn" title="Add Rectangle Shape">🔳</button>
      <button id="addTextBtn" title="Add Markdown Block">📋</button>
      <div class="divider"></div>
      <button id="lockDecorationsBtn" title="Lock/Unlock Decorations">🔓</button>
      <div class="divider"></div>
      <button id="groupSelectionBtn" title="Group Selected Decorations" disabled>Group</button>
      <button id="attachToNodeBtn" title="Attach Group to Node" disabled>Attach</button>
      <div class="divider"></div>
      <button id="exportBtn" title="Export">💾</button>
      <button id="resetBtn">Reset</button>
      <div class="divider"></div>
      <button id="deleteSelectionBtn" title="Delete Selected">🗑️</button>
    </div>
  </div>

  <!-- NEW: Floating title for current chapter -->
  <div id="floating-chapter-title" class="hidden"></div>

  
  <!-- Properties Inspector Panel (hidden) -->
  <div id="inspectorPanel" class="hidden">
      <h4>Properties</h4>
      <div id="inspectorContent"></div>
      <button id="saveNodeBtn">Save Changes</button>
      <button id="closeInspectorBtn">Close</button>
  </div>

  <!-- Player and other UI -->
  <div id="player">
    <div id="playerContent">
      <div id="songTitle">Select a node to begin...</div>
<div id="playerControls">
        <button id="tipJarBtn" title="Cosmic Tip Jar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 5H6a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1.5M14 5a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v0M8 5a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v0M12 17a2 2 0 0 0 2-2 2 2 0 0 0-2-2 2 2 0 0 0-2 2 2 2 0 0 0 2 2Z"/></svg>
        </button>
        <div class="player-controls-divider"></div>
        <button id="backBtn" title="Go Back">⏮</button>
        <button id="playBtn" title="Play/Pause">▶</button>
        <button id="nextBtn" title="Next">⏭</button>
        <div class="player-controls-divider"></div>
        <button id="tocBtn" title="Table of Contents">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"/></svg>
        </button>
      </div>
      <!-- NEW: Progress container on its own line -->
      <div id="progressContainer">
        <input type="range" id="progress" value="0">
        <span id="currentTime">0:00</span>
      </div>
    </div>
  </div>
  <div id="lyricsContainer" class="hidden">
    <pre id="lyricsText">Loading lyrics...</pre>
    <button id="closeLyricsBtn" title="Close">×</button>
  </div>
  <div id="choiceModal" class="hidden">
    <div class="modal-content">
      <h3>Choose the next step:</h3>
      <div id="choiceOptions"></div>
      <div id="choiceTimer" class="hidden">(Autoselecting in <span id="countdown">5</span>s)</div>
      <button id="closeModalBtn">Cancel</button>
    </div>
  </div>
  
  <!-- External Libraries for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <script src="js/app.js" type="module"></script>

  <!-- Table of Contents Modal -->
  <div id="tocModal" class="hidden">
    <div class="modal-content">
      <h3>Table of Contents</h3>
      <div id="tocContent"></div>
      <button id="closeTocBtn">Close</button>
    </div>
  </div>
  
  <!-- Graph Selection Modal -->
  <div id="graphSelectionModal" class="hidden">
    <div class="modal-content">
      <h3>Select a Story</h3>
      <div id="graphSelectionOptions"></div>
      <button id="closeGraphModalBtn">Cancel</button>
    </div>
  </div>

  <footer id="copyright">
    AVN Player © 2025 Nftxv — <a href="https://AbyssVoid.com/" target="_blank" rel="noopener nofollow">AbyssVoid.com</a>
  </footer>
</body>
</html>