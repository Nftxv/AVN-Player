<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
  <title>AVN Player</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Container for HTML overlays (iframes) -->
  <div id="iframe-container"></div>
  <!-- NEW: Container for Markdown overlays -->
  <div id="markdown-container"></div>

  <canvas id="graphCanvas" title="Graph"></canvas>

  <!-- UNIFIED TOP TOOLBAR -->
  <div id="topToolbar">
    
    <!-- Always Visible Buttons -->
    <button id="toggleAllNodesBtn" title="Collapse All Nodes">
      <!-- This content will be dynamically replaced by JS -->
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12"></line></svg>
    </button>
    <button id="followModeBtn" title="Lock current view and follow playback">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
    </button> 
    <button id="selectGraphBtn" title="Select Story" disabled>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>
    </button>
    <div class="divider"></div>

    <!-- Player Mode Controls -->
    <div id="playerModeControls">
      <div id="playbackModeSwitch" class="toggle-switch" title="Set Playback Mode">
        <button id="mode-default" class="active" title="Play only default paths">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
        </button>
        <button id="mode-alternative" title="Play only alternative paths">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12" stroke-dasharray="4 4"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
        </button>
        <button id="mode-random" title="Play any path randomly">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 3h5v5"/><path d="M4 20L21 3"/><path d="M21 16v5h-5"/><path d="M15 15l6 6"/></svg>
        </button>
      </div>
    </div>

    <!-- Editor Mode Controls (hidden by default) -->
    <div id="editorModeControls">
      <button id="addNodeBtn" title="Add New Node">ğŸ«</button>
      <button id="addRectBtn" title="Add Rectangle Shape">ğŸ”³</button>
      <button id="addTextBtn" title="Add Markdown Block">ğŸ“‹</button>
      <div class="divider"></div>
      <button id="lockDecorationsBtn" title="Lock/Unlock Decorations">ğŸ”“</button>
      <div class="divider"></div>
      <button id="groupSelectionBtn" title="Group Selected Decorations" disabled>Group</button>
      <button id="attachToNodeBtn" title="Attach Group to Node" disabled>Attach</button>
      <div class="divider"></div>
      <button id="exportBtn" title="Export">ğŸ’¾</button>
      <button id="resetBtn">Reset</button>
      <div class="divider"></div>
      <button id="deleteSelectionBtn" title="Delete Selected">ğŸ—‘ï¸</button>
    </div>
  </div>

  <!-- NEW: Floating title for current chapter -->
  <div id="floating-chapter-title" class="hidden"></div>

  
  <!-- Properties Inspector Panel (hidden) -->
  <div id="inspectorPanel" class="hidden">
      <h4>Properties</h4>
      <div id="inspectorContent"></div>
      <button id="saveNodeBtn">Save Changes</button>
      <button id="closeInspectorBtn">Close</button>
  </div>

  <!-- Player and other UI -->
  <div id="player">
    <div id="playerContent">
      <div id="songTitle">Select a node to begin...</div>
<div id="playerControls">
        <button id="tipJarBtn" title="Cosmic Tip Jar">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M7 3h10v2H7zM8 5h8v2H8z"/><path d="M7 7h10a2 2 0 0 1 2 2v9a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V9a2 2 0 0 1 2-2z"/></svg>
        </button>

        <div class="player-controls-divider"></div>

        <button id="backBtn" title="Go Back">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-back"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
        </button>
        <button id="playBtn" title="Play/Pause">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-play"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
        </button>
        <button id="nextBtn" title="Next">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-skip-forward"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
        </button>

        <div class="player-controls-divider"></div>

        <button id="tocBtn" title="Table of Contents">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="12" x2="20" y2="12"></line><line x1="4" y1="6" x2="20" y2="6"></line><line x1="4" y1="18" x2="20" y2="18"></line></svg>
        </button>
      </div>
      <!-- NEW: Progress container on its own line -->
      <div id="progressContainer">
        <input type="range" id="progress" value="0">
        <span id="currentTime">0:00</span>
      </div>
    </div>
  </div>
  <div id="lyricsContainer" class="hidden">
    <pre id="lyricsText">Loading lyrics...</pre>
    <button id="closeLyricsBtn" title="Close">Ã—</button>
  </div>
  <div id="choiceModal" class="hidden">
    <div class="modal-content">
      <h3>Choose the next step:</h3>
      <div id="choiceOptions"></div>
      <div id="choiceTimer" class="hidden">(Autoselecting in <span id="countdown">5</span>s)</div>
      <button id="closeModalBtn">Cancel</button>
    </div>
  </div>
  
  <!-- External Libraries for Markdown -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

  <script src="js/app.js" type="module"></script>

  <!-- Table of Contents Modal -->
  <div id="tocModal" class="hidden">
    <div class="modal-content">
      <h3>Table of Contents</h3>
      <div id="tocContent"></div>
      <button id="closeTocBtn">Close</button>
    </div>
  </div>
  
  <!-- Graph Selection Modal -->
  <div id="graphSelectionModal" class="hidden">
    <div class="modal-content">
      <h3>Select a Story</h3>
      <div id="graphSelectionOptions"></div>
      <button id="closeGraphModalBtn">Cancel</button>
    </div>
  </div>

  <footer id="copyright" title="About & License">
    <span class="copyright-icon">â“˜</span>
    <div class="copyright-text">
      <a href="https://abyssvoid.com/" target="_blank" rel="noopener noreferrer">AVN Player by Nftxv</a> | <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener noreferrer">CC BY-NC-SA</a>
    </div>
  </footer>
  
</body>
</html>